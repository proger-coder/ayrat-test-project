# Описание задания

Необходимо реализовать небольшой проект, который включает в себя 3 задачи.  
Код необходимо разместить в публичном репозитории на GitHub или GitLab.

## Стек технологий
- **Язык:** strict TypeScript
- **База данных:** postgres.js
- **Фреймворк:** на выбор (hono, elysia, fastify, express)
- **Запрещено использовать:** Nest, JWT, ORM

## Схема базы данных
Проект должен содержать три таблицы: `users`, `products`, `purchases`.  
Схему базы данных необходимо добавить в репозиторий.

---

## Задачи

### Задача 1: Регистрация, аутентификация, смена пароля
Реализовать базовую функциональность для работы с пользователями:

- Регистрация нового пользователя.
- Аутентификация пользователя по email и паролю.
- Смена пароля (требуется ввод старого и нового пароля).

### Задача 2: Отображение предметов с ценами
Реализовать эндпоинт, который возвращает массив объектов с двумя минимальными ценами на предмет (одна цена — `tradable`, другая — нет).
- Источник данных: [Skinport API](https://docs.skinport.com/#items) (параметры `app_id` и `currency` оставить по умолчанию).
- Использование Postgres для этой задачи **не требуется**.
- Добавить кэширование предметов через Redis.

### Задача 3: Покупка товара
Реализовать покупку товара из таблицы `products`:

- Заполнить таблицу `products` самостоятельно (несколько предметов, цена — float).
- У пользователя должен быть баланс.
- В ответе эндпоинта необходимо возвращать обновленный баланс пользователя.

---

## Комментарий разработчика

1. **Задача 1**:

    - со старта, проект имеет 2-х дефолтных пользователей:

       `Anna Petrova`: email: `anna.petrova@mail.ru`, баланс: `20000.0 EUR`;

       `Petr Sidorov`: email: `petr.sidorov@mail.ru`, баланс: `70000.0 EUR`;
    - паролями для них являются их **_электронные адреса_**;
    - для них также со старта добавляются начальные записи в таблицу `purchases`:
    - добавлено middleware для аутентификации;
    - оно настроено так, что не кидает ошибку, а перенаправляет на страницу логина или регистрации;

2. **Задача 2**:

    - реализована удобная наглядная таблица с выделенными **_двумя минимальными ценами_**;
    - для облегчения страницы, по умолчанию выводятся первые 100 предметов;
    - имеется кнопка, которая подгрузит весь список полностью (их примерно 24 000);
    - при первом запуске и обращении к эндпоинту, будет ожидание, т.к. данные ещё не кэшированы;
    - реализована пагинация (постраничный просмотр): для этого в строке url надо добавить `?page=x&limit=y`, где `x` — номер страницы, `y` — количество элементов на страницу;
    - по умолчанию, параметр `page` равен `1`, а `limit` равен `100`;

2. **Задача 3**:

    - таблица `products` заполняется со старта;
    - у новых пользователей есть начальный баланс `50 000` EUR;
    - функционал покупки доступен авторизованным пользователям;
    - после покупки баланс пользователя и колиество предметов уменьшается;
    - в ответном сообщении эндпоинта содержится обновлённый баланс пользователя;
    - если пользователь не имеет достаточного баланса, то он не может купить предмет;
    - если предмет закончился, то он не может быть куплен;

---

## Основные технологии

- **Docker**: контейнеризация приложения.
- **Express**: веб-фреймворк для создания серверного приложения.
- **PostgreSQL**: база данных для хранения информации о пользователях, товарах и покупках.
- **Redis**: используется для хранения сессий и кэширования данных.
- **bcrypt**: библиотека для хэширования паролей.
- **Pug**: шаблонизатор для серверного рендеринга HTML.
- **Bootstrap**: библиотека для стилизации интерфейса.

---

## Основные роуты

### Аутентификация и авторизация

1. **`POST /register`**
   - Регистрация нового пользователя.
   - Требует: `username`, `email`, `password`.
   - Ответы:
     - `201`: Пользователь успешно зарегистрирован.
     - `400`: Не указаны обязательные параметры.
     - `409`: Пользователь с таким email уже существует.

2. **`POST /login`**
   - Аутентификация пользователя.
   - Требует: `email`, `password`.
   - Ответы:
     - `200`: Успешный вход в систему.
     - `400`: Не указаны email или пароль.
     - `401`: Неправильный email или пароль.

3. **`POST /change-password`**
   - Смена пароля авторизованным пользователем.
   - Требует: `oldPassword`, `newPassword`.
   - Ответы:
     - `200`: Пароль успешно обновлён.
     - `401`: Пользователь не авторизован или старый пароль неверный.

4. **`POST /logout`**
   - Завершение сессии пользователя.
   - Ответы:
     - `200`: Сессия завершена.

### Рабочие маршруты

1. **`GET /products`**
   - Получение списка товаров.
   - Ответы:
     - `200`: Успешное получение списка товаров.

2. **`POST /buy/:productId`**
   - Покупка товара по ID.
   - Ответы:
     - `201`: Покупка завершена успешно.
     - `400`: Товар закончился или недостаточно средств.
     - `404`: Товар не найден.

3. **`GET /profile`**
   - Просмотр профиля пользователя, включая историю покупок и текущий баланс.
   - Ответы:
     - `200`: Успешное получение данных профиля.
     - `401`: Пользователь не авторизован.

4. **`GET /items`**
   - Получение списка предметов с поддержкой кэширования и пагинации.
   - Параметры:
     - `page`: номер страницы (по умолчанию `1`).
     - `limit`: количество элементов на страницу (по умолчанию `100`).
   - Ответы:
     - `200`: Успешное получение данных.

---

## Архитектура

1. **Сессии**
   - Используется библиотека `express-session`.
   - Redis выступает как хранилище сессий с использованием префикса `sess:`.

2. **Кэширование**
   - Товары кэшируются в Redis для оптимизации производительности.
   - Данные кешируются с ограничением по времени (`CACHE_TTL`).

3. **Транзакции**
   - Используются для обеспечения атомарности операций при покупке товаров.
   - Включают обновление баланса пользователя, количества товаров и добавление записи о покупке.

4. **Хэширование паролей**
   - Библиотека `bcrypt` используется для безопасного хэширования паролей с использованием соли (`SALT_ROUNDS`).

---


## Важные моменты

1. Для запуска нужен **Docker** и **docker-compose**.

2. Запуск осуществляется из папки, где находится файл `docker-compose.yml`.

### Команды для запуска
- Для свежих версий `docker-compose` используйте:
  ```bash
  docker compose up --build
  ```

- Для старых версий `docker-compose` (с тире) команда будет выглядеть так:
  ```bash
  docker-compose up --build
  ```

Если запуск прошёл успешно, в консоли появятся строки:
```
INFO: Программа запущена
INFO: Главная http://localhost:3000
```
Обычно ссылка кликабельна и ведёт на главную страницу.

### Команды для остановки проекта
- Для остановки проекта:
  ```bash
  docker compose down
  ```
- Для остановки проекта с удалением всех хранилищ (volumes):
  ```bash
  docker compose down -v
  ```

### Переменные среды
Все необходимые переменные уже прописаны в коде или в файлах `docker-compose.yml`. Это сделано для удобства, чтобы проект можно было запускать практически "в один клик" без необходимости настройки дополнительных переменных среды.

